---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getProducts, getProductBySlug } from '../../../lib/wp';
import { fallbackPaintings } from '../../../lib/fallbackPaintings';
import { slugify } from '../../../lib/slugify';

export const prerender = false;

const { slug } = Astro.params;
const normalizeSlug = (value = '') =>
  value.toLowerCase().replace(/-\d{2,3}x\d{2,3}.*$/i, '').replace(/-+$/g, '');
const humanizeSlug = (value = '') => {
  const cleaned = normalizeSlug(value).replace(/-/g, ' ').trim().toLowerCase();
  if (!cleaned) return 'Woman with Moon';
  const minorWords = new Set(['of', 'the', 'a', 'an', 'and', 'with']);
  return cleaned
    .split(' ')
    .filter(Boolean)
    .map((word, index) => {
      if (index > 0 && minorWords.has(word)) return word;
      return word.charAt(0).toUpperCase() + word.slice(1);
    })
    .join(' ');
};

const paintingsFromWp = (await getProducts(120)).filter(painting => painting.image);
const paintings =
  paintingsFromWp.length > 0
    ? paintingsFromWp
    : fallbackPaintings.map(item => ({ ...item, link: '#!', slug: slugify(item.title) }));

const findPainting = (items: typeof paintings, targetSlug?: string) => {
  if (!targetSlug) return undefined;
  const normalizedTarget = normalizeSlug(targetSlug);
  return items.find(item => {
    const itemSlug = item.slug ?? slugify(item.title);
    return itemSlug === targetSlug || normalizeSlug(itemSlug) === normalizedTarget;
  });
};

let painting = findPainting(paintings, slug);
if (!painting && slug) {
  painting = await getProductBySlug(slug);
}
const normalizedSlug = slug ? normalizeSlug(slug) : '';
if (!painting && normalizedSlug && normalizedSlug !== slug) {
  painting = findPainting(paintings, normalizedSlug) || (await getProductBySlug(normalizedSlug));
}

const fallbackTitle = slug ? humanizeSlug(slug) : 'Woman with Moon';
const paintingTitle = painting?.title ?? fallbackTitle;
const paintingImage = painting?.image ?? paintings[0]?.image ?? '/gallerie/gallerie-virtuelle.png';
const detailText = painting?.description || 'Original artwork.';
const dimensions = painting?.dimensions ?? '—';
const medium = painting?.medium ?? '—';
const pageTitle = `${paintingTitle} – My Light Gallery Art`;
const description = painting?.description || 'Artwork details available from the gallery.';
const phoneLabel = '+1 (214) 537-6953';
const phoneHref = 'tel:+12145376953';
const email = 'layla@mylightartgallery.com';
const currentUrl = Astro.url?.href ?? '';
const shareUrl = encodeURIComponent(currentUrl);
const shareImage = encodeURIComponent(painting?.image ?? '');
const shareTitle = encodeURIComponent(paintingTitle);
const facebookShare = `https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`;
const pinterestShare =
  `https://pinterest.com/pin/create/button/?url=${shareUrl}&media=${shareImage}&description=${shareTitle}`;
const instagramHref = 'https://www.instagram.com/mylightgalleryart/';
---

<BaseLayout lang="en" title={pageTitle} description={description}>
  <div class="rg-artwork-page">
    <section class="rg-artwork-hero">
      <div class="container">
        <a class="rg-back-link" href="/en/exhibitions">← Back to works</a>
      </div>
    </section>

    <section class="rg-artwork-content">
      <div class="container rg-artwork-grid">
        <div class="rg-artwork-images">
          <div class="rg-artwork-visual">
            <span class="rg-artwork-label">Without frame</span>
            {paintingImage ? (
              <img
                src={paintingImage}
                alt={paintingTitle}
                loading="lazy"
                decoding="async"
                data-zoomable
              />
            ) : (
              <div class="rg-artwork-placeholder"></div>
            )}
          </div>
          <div
            class="rg-artwork-visual rg-artwork-certificate"
            id="certificate-panel"
            data-certificate-panel
          >
            <span class="rg-artwork-label">Certificate of Authenticity</span>
            <div class="rg-certificate-card">
              <p>Certificate of Authenticity (COA)</p>
            </div>
          </div>
        </div>

        <aside class="rg-artwork-details">
          <h1>{paintingTitle}</h1>
          <dl class="rg-artwork-specs">
            <div>
              <dt>Details</dt>
              <dd>{detailText}</dd>
            </div>
            <div>
              <dt>Dimensions</dt>
              <dd>{dimensions}</dd>
            </div>
            <div>
              <dt>Technique</dt>
              <dd>{medium}</dd>
            </div>
          </dl>
          <p class="rg-artwork-sale">This artwork is for sale.</p>
          <button
            class="rg-certificate-btn"
            type="button"
            data-certificate-toggle
            aria-controls="certificate-panel"
            aria-expanded="false"
          >
            OCA Certificate
          </button>
          <p class="rg-artwork-contact">
            Send an enquiry or contact us:
            <a href={phoneHref}>{phoneLabel}</a>
            <span aria-hidden="true"> · </span>
            <a href={`mailto:${email}`}>{email}</a>
          </p>
          <div class="rg-artwork-share">
            <span>Share</span>
            <a href={facebookShare} target="_blank" rel="noopener noreferrer" aria-label="Share on Facebook">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M22 12a10 10 0 1 0-11.5 9.9v-7H8.3V12h2.2V9.8c0-2.2 1.3-3.4 3.3-3.4.96 0 2 .17 2 .17v2.2h-1.1c-1.1 0-1.4.68-1.4 1.37V12h2.4l-.38 2.9h-2v7A10 10 0 0 0 22 12Z"/>
              </svg>
            </a>
            <a href={pinterestShare} target="_blank" rel="noopener noreferrer" aria-label="Share on Pinterest">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2a10 10 0 0 0-3.6 19.3c-.05-.8-.1-2 .02-2.9l1.1-4.7s-.3-.6-.3-1.5c0-1.4.8-2.4 1.8-2.4.8 0 1.2.6 1.2 1.3 0 .8-.5 2-.7 3.2-.2 1 .4 1.8 1.5 1.8 1.8 0 3.2-1.9 3.2-4.6 0-2.4-1.7-4.1-4.1-4.1-2.8 0-4.5 2.1-4.5 4.3 0 .9.3 1.8.7 2.3.1.1.1.2.1.4l-.3 1.3c-.1.3-.2.3-.5.2-1.6-.7-2.6-2.9-2.6-4.7 0-3.8 2.8-7.3 8-7.3 4.2 0 7.5 3 7.5 7.1 0 4.2-2.7 7.6-6.4 7.6-1.2 0-2.4-.6-2.8-1.4l-.7 2.6c-.2.9-.8 2-1.2 2.6A10 10 0 0 0 22 12 10 10 0 0 0 12 2Z"/>
              </svg>
            </a>
            <a href={instagramHref} target="_blank" rel="noopener noreferrer" aria-label="Visit Instagram">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M7 3h10a4 4 0 0 1 4 4v10a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V7a4 4 0 0 1 4-4Zm10 2H7a2 2 0 0 0-2 2v10c0 1.1.9 2 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm-5 3.5A3.5 3.5 0 1 1 8.5 12 3.5 3.5 0 0 1 12 8.5Zm0 2A1.5 1.5 0 1 0 13.5 12 1.5 1.5 0 0 0 12 10.5Zm4.5-3.8a1 1 0 1 1-1-1 1 1 0 0 1 1 1Z"/>
              </svg>
            </a>
          </div>
        </aside>
      </div>
    </section>

    <div class="rg-lightbox" aria-hidden="true">
      <button class="rg-lightbox-close" type="button" aria-label="Close">×</button>
      <img alt="" />
      <p class="rg-lightbox-hint">Click the image to zoom in.</p>
    </div>
  </div>
</BaseLayout>

<script>
  const lightbox = document.querySelector('.rg-lightbox');
  const lightboxImage = lightbox?.querySelector('img');
  const lightboxClose = lightbox?.querySelector('.rg-lightbox-close');
  const zoomables = document.querySelectorAll('[data-zoomable]');
  const certificateToggle = document.querySelector('[data-certificate-toggle]');
  const certificatePanel = document.querySelector('[data-certificate-panel]');
  let zoomed = false;

  const openLightbox = (src, alt) => {
    if (!lightbox || !lightboxImage) return;
    lightboxImage.src = src;
    lightboxImage.alt = alt;
    lightbox.classList.add('is-visible');
    lightbox.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    zoomed = false;
    lightboxImage.classList.remove('is-zoomed');
  };

  const closeLightbox = () => {
    if (!lightbox || !lightboxImage) return;
    lightbox.classList.remove('is-visible');
    lightbox.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    zoomed = false;
    lightboxImage.classList.remove('is-zoomed');
  };

  zoomables.forEach(img => {
    img.addEventListener('click', () => openLightbox(img.src, img.alt));
  });

  lightboxClose?.addEventListener('click', closeLightbox);
  lightbox?.addEventListener('click', event => {
    if (event.target === lightbox) {
      closeLightbox();
    }
  });

  lightboxImage?.addEventListener('click', event => {
    event.stopPropagation();
    zoomed = !zoomed;
    lightboxImage.classList.toggle('is-zoomed', zoomed);
  });

  document.addEventListener('keydown', event => {
    if (event.key === 'Escape') {
      closeLightbox();
    }
  });

  certificateToggle?.addEventListener('click', () => {
    if (!certificatePanel) return;
    const isVisible = certificatePanel.classList.toggle('is-visible');
    certificateToggle.setAttribute('aria-expanded', String(isVisible));
    if (isVisible) {
      certificatePanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
</script>

<style>
  .rg-artwork-page {
    --rg-ink: #1d1a16;
    --rg-muted: #6f675f;
    --rg-line: #d7cfc2;
    --rg-paper: #fbf8f2;
    background:
      radial-gradient(circle at 12% 15%, rgba(255, 255, 255, 0.85), transparent 55%),
      linear-gradient(140deg, rgba(248, 244, 238, 0.96), rgba(231, 222, 210, 0.98));
    color: var(--rg-ink);
    font-family: 'Roboto', sans-serif;
    min-height: 100vh;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .rg-artwork-hero {
    padding: 3.5rem 2rem 0;
  }

  .rg-back-link {
    text-decoration: none;
    color: var(--rg-ink);
    text-transform: uppercase;
    letter-spacing: 0.2em;
    font-size: 0.75rem;
  }

  .rg-artwork-content {
    padding: 2.5rem 2rem 6rem;
  }

  .rg-artwork-grid {
    display: grid;
    grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
    gap: 3rem;
    align-items: start;
  }

  .rg-artwork-images {
    display: grid;
    gap: 2rem;
  }

  .rg-artwork-visual {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid var(--rg-line);
    padding: 1.5rem;
    box-shadow: 0 18px 40px rgba(40, 30, 20, 0.1);
  }

  .rg-artwork-visual img {
    width: 100%;
    height: auto;
    display: block;
    cursor: zoom-in;
  }

  .rg-artwork-certificate {
    display: none;
  }

  .rg-artwork-certificate.is-visible {
    display: block;
  }

  .rg-certificate-card {
    border: 1px dashed rgba(90, 70, 54, 0.45);
    padding: 2.5rem 2rem;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    font-size: 0.8rem;
    color: var(--rg-muted);
    background: rgba(255, 255, 255, 0.7);
  }

  .rg-artwork-label {
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 0.3em;
    font-size: 0.7rem;
    color: var(--rg-muted);
    margin-bottom: 0.85rem;
  }

  .rg-artwork-placeholder {
    width: 100%;
    height: 360px;
    background: rgba(210, 200, 190, 0.4);
  }

  .rg-artwork-details h1 {
    font-family: 'Times New Roman', Times, serif;
    font-size: clamp(2.2rem, 4vw, 3.2rem);
    letter-spacing: 0.08em;
    margin: 0 0 1.5rem;
    text-transform: uppercase;
  }

  .rg-artwork-specs {
    margin: 0 0 1.5rem;
    display: grid;
    gap: 1rem;
  }

  .rg-artwork-specs div {
    display: flex;
    justify-content: space-between;
    gap: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--rg-line);
  }

  .rg-artwork-specs dt {
    font-size: 0.75rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    font-weight: 600;
  }

  .rg-artwork-specs dd {
    margin: 0;
    color: var(--rg-muted);
    text-align: right;
  }

  .rg-artwork-sale {
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-weight: 600;
    margin: 0 0 1.25rem;
  }

  .rg-certificate-btn {
    align-self: flex-start;
    margin: 0 0 1.5rem;
    background: transparent;
    border: 1px solid var(--rg-ink);
    color: var(--rg-ink);
    text-transform: uppercase;
    letter-spacing: 0.18em;
    font-size: 0.75rem;
    padding: 0.7rem 1.4rem;
    cursor: pointer;
    transition: background 0.2s ease, color 0.2s ease;
  }

  .rg-certificate-btn:hover {
    background: var(--rg-ink);
    color: #fff;
  }

  .rg-artwork-contact {
    color: var(--rg-muted);
    margin: 0 0 1.75rem;
    line-height: 1.6;
  }

  .rg-artwork-contact a {
    color: var(--rg-ink);
    text-decoration: none;
    border-bottom: 1px solid var(--rg-line);
  }

  .rg-artwork-share {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    font-size: 0.7rem;
  }

  .rg-artwork-share a {
    width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 999px;
    border: 1px solid var(--rg-ink);
    color: var(--rg-ink);
    text-decoration: none;
    transition: background 0.2s ease, color 0.2s ease;
  }

  .rg-artwork-share a:hover {
    background: var(--rg-ink);
    color: #fff;
  }

  .rg-artwork-share svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
  }

  .rg-lightbox {
    position: fixed;
    inset: 0;
    background: rgba(10, 8, 6, 0.92);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 1.5rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
    z-index: 2000;
    padding: 2.5rem;
  }

  .rg-lightbox.is-visible {
    opacity: 1;
    pointer-events: auto;
  }

  .rg-lightbox img {
    width: min(90vw, 1200px);
    max-height: 85vh;
    object-fit: contain;
    cursor: zoom-in;
    transition: transform 0.3s ease;
    box-shadow: 0 28px 80px rgba(0, 0, 0, 0.45);
  }

  .rg-lightbox img.is-zoomed {
    transform: scale(1.6);
    cursor: zoom-out;
  }

  .rg-lightbox-close {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    width: 42px;
    height: 42px;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.6);
    background: transparent;
    color: #fff;
    font-size: 1.5rem;
    cursor: pointer;
  }

  .rg-lightbox-hint {
    color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.2em;
    font-size: 0.65rem;
    margin: 0;
  }

  @media (max-width: 960px) {
    .rg-artwork-grid {
      grid-template-columns: 1fr;
    }

    .rg-artwork-specs dd {
      text-align: left;
    }
  }

  @media (max-width: 600px) {
    .rg-artwork-visual {
      padding: 1rem;
    }

    .rg-artwork-placeholder {
      height: 240px;
    }

    .rg-artwork-specs div {
      flex-direction: column;
    }

    .rg-lightbox img.is-zoomed {
      transform: scale(1.2);
    }
  }
</style>
